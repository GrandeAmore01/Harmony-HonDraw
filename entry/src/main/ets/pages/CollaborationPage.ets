import { router } from '@kit.ArkUI'
import { picker } from '@kit.CoreFileKit'
import { promptAction } from '@kit.ArkUI'

// ååŒç¼–è¾‘é¡µé¢ - åˆ›å»ºæˆ–åŠ å…¥ååŒç¼–è¾‘ä¼šè¯
@Entry
@Component
struct CollaborationPage {
  @State sessionCode: string = ''
  @State userName: string = ''
  @State showCreateSession: boolean = true

  // ç”Ÿæˆéšæœºä¼šè¯ç 
  generateSessionCode(): string {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'
    let code = ''
    for (let i = 0; i < 6; i++) {
      code += chars.charAt(Math.floor(Math.random() * chars.length))
    }
    return code
  }

  // åˆ›å»ºååŒä¼šè¯
  async createSession() {
    if (!this.userName || this.userName.trim() === '') {
      promptAction.showToast({
        message: 'è¯·è¾“å…¥ç”¨æˆ·å',
        duration: 2000
      })
      return
    }

    try {
      const photoSelectOptions = new picker.PhotoSelectOptions()
      photoSelectOptions.MIMEType = picker.PhotoViewMIMETypes.IMAGE_TYPE
      photoSelectOptions.maxSelectNumber = 1

      const photoPicker = new picker.PhotoViewPicker()
      const result = await photoPicker.select(photoSelectOptions)

      if (result && result.photoUris && result.photoUris.length > 0) {
        const imageUri = result.photoUris[0]
        const sessionCode = this.generateSessionCode()

        // è·³è½¬åˆ°ååŒç¼–è¾‘å™¨
        router.pushUrl({
          url: 'pages/CollaborativeEditorPage',
          params: {
            imageUri: imageUri,
            sessionCode: sessionCode,
            userName: this.userName,
            isHost: true
          }
        })
      }
    } catch (err) {
      console.error('åˆ›å»ºä¼šè¯å¤±è´¥:', JSON.stringify(err))
    }
  }

  // åŠ å…¥ååŒä¼šè¯
  joinSession() {
    if (!this.userName || this.userName.trim() === '') {
      promptAction.showToast({
        message: 'è¯·è¾“å…¥ç”¨æˆ·å',
        duration: 2000
      })
      return
    }

    if (!this.sessionCode || this.sessionCode.trim() === '') {
      promptAction.showToast({
        message: 'è¯·è¾“å…¥ä¼šè¯ç ',
        duration: 2000
      })
      return
    }

    // è·³è½¬åˆ°ååŒç¼–è¾‘å™¨
    router.pushUrl({
      url: 'pages/CollaborativeEditorPage',
      params: {
        sessionCode: this.sessionCode.toUpperCase(),
        userName: this.userName,
        isHost: false
      }
    })
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Text('â†')
          .fontSize(24)
          .fontColor('#1A1A1A')
          .onClick(() => {
            router.back()
          })

        Text('ååŒç¼–è¾‘')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1A1A1A')
          .margin({ left: 12 })
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#FFFFFF')
      .shadow({
        radius: 4,
        color: '#10000000',
        offsetY: 2
      })

      Scroll() {
        Column({ space: 24 }) {
          // ååŒç¼–è¾‘è¯´æ˜
          Column({ space: 12 }) {
            Text('ğŸ‘¥ å¤šäººå®æ—¶ååŒç¼–è¾‘')
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor('#1A1A1A')

            Text('é‚€è¯·ä»–äººä¸€èµ·ç¼–è¾‘å›¾ç‰‡ï¼Œå®æ—¶æŸ¥çœ‹ç¼–è¾‘æ•ˆæœ')
              .fontSize(14)
              .fontColor('#666666')
              .lineHeight(22)
          }
          .width('100%')
          .alignItems(HorizontalAlign.Start)

          // ç”¨æˆ·åè¾“å…¥
          Column({ space: 8 }) {
            Text('ç”¨æˆ·å')
              .fontSize(14)
              .fontColor('#333333')
              .alignSelf(ItemAlign.Start)

            TextInput({ placeholder: 'è¯·è¾“å…¥æ‚¨çš„ç”¨æˆ·å' })
              .height(48)
              .fontSize(16)
              .backgroundColor('#F5F5F5')
              .borderRadius(8)
              .onChange((value: string) => {
                this.userName = value
              })
          }
          .width('100%')

          // åˆ›å»º/åŠ å…¥é€‰é¡¹å¡
          Row() {
            Button('åˆ›å»ºä¼šè¯')
              .fontSize(16)
              .fontWeight(this.showCreateSession ? FontWeight.Bold : FontWeight.Normal)
              .height(44)
              .layoutWeight(1)
              .backgroundColor(this.showCreateSession ? '#007DFF' : '#FFFFFF')
              .fontColor(this.showCreateSession ? '#FFFFFF' : '#666666')
              .onClick(() => {
                this.showCreateSession = true
              })

            Button('åŠ å…¥ä¼šè¯')
              .fontSize(16)
              .fontWeight(!this.showCreateSession ? FontWeight.Bold : FontWeight.Normal)
              .height(44)
              .layoutWeight(1)
              .backgroundColor(!this.showCreateSession ? '#007DFF' : '#FFFFFF')
              .fontColor(!this.showCreateSession ? '#FFFFFF' : '#666666')
              .onClick(() => {
                this.showCreateSession = false
              })
          }
          .width('100%')
          .borderRadius(8)
          .backgroundColor('#FFFFFF')
          .shadow({
            radius: 4,
            color: '#10000000',
            offsetY: 2
          })

          // åˆ›å»ºä¼šè¯é¢æ¿
          if (this.showCreateSession) {
            Column({ space: 16 }) {
              Column({ space: 12 }) {
                Text('ğŸ“± åˆ›å»ºæ–°çš„ååŒç¼–è¾‘ä¼šè¯')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#1A1A1A')
                  .alignSelf(ItemAlign.Start)

                Text('é€‰æ‹©ä¸€å¼ å›¾ç‰‡å¼€å§‹ï¼Œç³»ç»Ÿå°†ç”Ÿæˆä¼šè¯ç åˆ†äº«ç»™å…¶ä»–äºº')
                  .fontSize(14)
                  .fontColor('#666666')
                  .lineHeight(22)
                  .alignSelf(ItemAlign.Start)
              }

              Button('é€‰æ‹©å›¾ç‰‡å¹¶åˆ›å»ºä¼šè¯')
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .height(48)
                .width('100%')
                .backgroundColor('#007DFF')
                .borderRadius(24)
                .onClick(() => {
                  this.createSession()
                })

              // åŠŸèƒ½è¯´æ˜
              Column({ space: 8 }) {
                this.FeatureItem('âœ“ å®æ—¶åŒæ­¥ç¼–è¾‘æ“ä½œ')
                this.FeatureItem('âœ“ æ˜¾ç¤ºåä½œè€…å…‰æ ‡ä½ç½®')
                this.FeatureItem('âœ“ å†²çªè‡ªåŠ¨è§£å†³')
                this.FeatureItem('âœ“ æ”¯æŒæœ€å¤š5äººåŒæ—¶ç¼–è¾‘')
              }
              .width('100%')
              .padding(16)
              .backgroundColor('#F0F7FF')
              .borderRadius(12)
            }
            .width('100%')
            .padding(20)
            .backgroundColor('#FFFFFF')
            .borderRadius(16)
            .shadow({
              radius: 8,
              color: '#10000000',
              offsetY: 2
            })
          }

          // åŠ å…¥ä¼šè¯é¢æ¿
          if (!this.showCreateSession) {
            Column({ space: 16 }) {
              Column({ space: 12 }) {
                Text('ğŸ”— åŠ å…¥å·²æœ‰çš„ååŒç¼–è¾‘ä¼šè¯')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#1A1A1A')
                  .alignSelf(ItemAlign.Start)

                Text('è¾“å…¥ä¼šè¯ç å³å¯åŠ å…¥ä»–äººåˆ›å»ºçš„ç¼–è¾‘ä¼šè¯')
                  .fontSize(14)
                  .fontColor('#666666')
                  .lineHeight(22)
                  .alignSelf(ItemAlign.Start)
              }

              Column({ space: 8 }) {
                Text('ä¼šè¯ç ')
                  .fontSize(14)
                  .fontColor('#333333')
                  .alignSelf(ItemAlign.Start)

                TextInput({ placeholder: 'è¯·è¾“å…¥6ä½ä¼šè¯ç ' })
                  .height(48)
                  .fontSize(20)
                  .fontWeight(FontWeight.Bold)
                  .textAlign(TextAlign.Center)
                  .backgroundColor('#F5F5F5')
                  .borderRadius(8)
                  .maxLength(6)
                  .onChange((value: string) => {
                    this.sessionCode = value.toUpperCase()
                  })
              }

              Button('åŠ å…¥ä¼šè¯')
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .height(48)
                .width('100%')
                .backgroundColor('#52C41A')
                .borderRadius(24)
                .onClick(() => {
                  this.joinSession()
                })
            }
            .width('100%')
            .padding(20)
            .backgroundColor('#FFFFFF')
            .borderRadius(16)
            .shadow({
              radius: 8,
              color: '#10000000',
              offsetY: 2
            })
          }

          // ä½¿ç”¨æç¤º
          Column({ space: 12 }) {
            Text('ğŸ’¡ æ¸©é¦¨æç¤º')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#E6A23C')

            Text('â€¢ ç¡®ä¿æ‚¨ä¸åä½œè€…åœ¨åŒä¸€ç½‘ç»œç¯å¢ƒ\nâ€¢ ä¼šè¯ç åœ¨åˆ›å»ºå24å°æ—¶å†…æœ‰æ•ˆ\nâ€¢ ä¸»æŒäººé€€å‡ºåä¼šè¯å°†è‡ªåŠ¨ç»“æŸ\nâ€¢ æ‰€æœ‰ç¼–è¾‘æ“ä½œå®æ—¶åŒæ­¥')
              .fontSize(13)
              .fontColor('#666666')
              .lineHeight(22)
          }
          .width('100%')
          .padding(16)
          .backgroundColor('#FFF9E6')
          .borderRadius(12)
          .border({ width: 1, color: '#FFE58F' })
        }
        .padding(20)
      }
      .layoutWeight(1)
      .backgroundColor('#F5F5F5')
    }
    .width('100%')
    .height('100%')
  }

  // åŠŸèƒ½é¡¹
  @Builder
  FeatureItem(text: string) {
    Row({ space: 8 }) {
      Text(text)
        .fontSize(14)
        .fontColor('#333333')
    }
    .width('100%')
  }
}

